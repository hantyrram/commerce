<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>require('dotenv').config();
const path = require('path');
const MongoClient = require('mongodb').MongoClient;
const ObjectID = require('mongodb').ObjectID;
const cookieParser = require('cookie-parser');
const express = require('express');
const server = express();
const config = require('./config');
const sessionOnRedis = require('../local_modules/session-on-redis');
const authentication = require('../local_modules/authentication');
//Policy Based Authorization
const authorization = require('../local_modules/authorization');
global.Artifact = require('./Artifact');
global.Rule = require('../local_modules/authorization').Rule;
global.Policy = require('../local_modules/authorization').Policy;
global.PolicyViolation = require('../local_modules/authorization').PolicyViolation;
global._2xxResponse = require('./responses/2xx');
global._4xxResponse = require('./responses/4xx');
global._5xxResponse = require('./responses/5xx');

let serverStarted = false;
/**
 * @type {Object} 
 * @desc Mongo DB database
 */
let db;

/**
 * @returns {Array} - The array of middlewares as defined on the middlewares config.
 */
 global.getMiddlewares = ()=>{
  return config.middlewares.map((middleware)=>{
    return require(path.resolve(process.cwd()+middleware));
  })
}

/**
 * @global
 * @param {string} name of the middleware.
 * @return {function} the middleware with the given name.
 */
global.getMiddleware = (name)=>{
  
  return getMiddlewares().find(middleware=>{
    return middleware.name === name;
  })
}

/**
 * @global
 * @returns {Array} - The array of services as defined on the services config
 */
global.getServices = () => {
  return config.services.map((pathToService)=>{
    return require(path.resolve(process.cwd() + pathToService));
  })
}

/**
 * @returns {Array} - The array of routes as defined on the routes config
 */
global.getRoutes = ()=>{
 return config.routes;
}

global.errorsHandlers = ()=>{
  return config.errorHandlers.map(handler=>{
   return require('./error_handlers/' + handler);
  });
}
/**
 * Loads the route definitions on the express app, using the serviceProvider as responder.
 * Loads the middlewares specific to the routes as well.
 * If a route does not have the 'method' key, default value is 'get'.
 * @param {object} app - The express app
 * @param {Array} routes - Array of routes
 * @param {Array} services - Array of services
 */
const init = (app)=>{
 
 app.use(express.static(process.cwd()+'/tempimages'));//just to serve the favicon temporarily
 
 app.use(express.json());
 app.use(cookieParser());
 app.use(sessionOnRedis());

 authentication.serializeUser(function(user,done){
  done(user._id);//save the _id only to the session
 });
 authentication.deserializeUser(function(id,done){
  app.get('db').collection('users').findOne(ObjectID(id),function(err,result){
    let user = {};
    user.id = result._id;
    user.username = result.username;
    //save only the id,username on the req.object
    done(user);
  });
 });

 //deserializes the roles,of the currently logged in user, pass the array of roles to done callback
 //done([{name:'admin',label:'Admin',permissions:[...]},...])
//  authorization.deserializeUserRoles(function(currentLoggedInUser,done){
//   if(currentLoggedInUser.roles !== undefined &amp;&amp; currentLoggedInUser.roles.length !== 0){
//    //query roles with role names = the current user's roles e.g. ['admin','product_manager']
//    app.get('db').collection('roles')
//    .find({$or: currentLoggedInUser.roles.map(roleName=>{name:roleName})})
//    .toArray(function(error,documents){
//     done(documents);
//    });
//   }
//  });
 //end authorization 
 app.use(getMiddleware('handleNonXHR'));
 app.use(getMiddleware('attachArtifactToResponse'))
 app.use(getMiddleware('attachCurrentServiceToReq'));
 app.use(authentication.init({loginURL:'/'+config.API_VERSION+'/login'})); 
 // let attachCurrentServiceToReq = require('./middlewares/attachCurrentServiceToReq');
 // app.use(attachCurrentServiceToReq);
  
 const DEFAULT_REQUEST_METHOD = 'get';

 let routes = getRoutes();
 for(let i = 0; i &lt; routes.length; i++){
  let route = routes[i];
  let serviceProvider = getServices().find(service=>route.serviceProvider === service.name);
  if(serviceProvider){  //only define routes that has an existing service provider
   //get middlewares
   let routeSpecificMiddlewares;
   if(route.middlewares &amp;&amp; route.middlewares.length > 0){
    routeSpecificMiddlewares = getMiddlewares().filter(middleware=>{
     return route.middlewares.find(middlewareName=>{middlewareName === middleware.name})
    }); 
   }
   if(routeSpecificMiddlewares){
    app[route.method || DEFAULT_REQUEST_METHOD](route.path,routeSpecificMiddlewares,serviceProvider);
    continue;
   }
   app[route.method || DEFAULT_REQUEST_METHOD](route.path,serviceProvider);
  }
  
 }
//  console.log(app._router.stack);
 app.use(errorsHandlers());

}

/**
 * Start the server. Mount other apps
 * @param {object} server - The express app
 */
const start = (server)=>{
 const app = express();
 app.set('db',db);
 init(app);
 server.use(app);
 server.listen(process.env.PORT || 1234,function(){
  serverStarted = true;
  console.log('Server Started: ',serverStarted);
 });
}

server.on('dependency-ready',function(dependency){
 switch(Object.getOwnPropertyNames(dependency)[0]){
  case 'db':{
   db = dependency.db;
  }
 }
 if(db &amp;&amp; !serverStarted){
  start(server);
 }
});

//1. prepare db
(async function(){
 try {
  let client = new MongoClient(process.env.MONGODB_URI,{useNewUrlParser:true});
  await client.connect();
  server.emit('dependency-ready',{db:client.db(process.env.MONGODB_DBNAME)});
 } catch (error) {
  console.log(error);
 }
})()
//may add additional dependency asyncronously


</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Authentication.html">Authentication</a></li></ul><h3>Classes</h3><ul><li><a href="Artifact.html">Artifact</a></li><li><a href="Message.html">Message</a></li><li><a href="Policy.html">Policy</a></li><li><a href="Rule.html">Rule</a></li></ul><h3>Namespaces</h3><ul><li><a href="HT.html">HT</a></li><li><a href="Services.html">Services</a></li></ul><h3>Global</h3><ul><li><a href="global.html#condition">condition</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#deserializeUserRoles">deserializeUserRoles</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#done">done</a></li><li><a href="global.html#ERROR">ERROR</a></li><li><a href="global.html#genuuidV4">genuuidV4</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getMiddleware">getMiddleware</a></li><li><a href="global.html#getServices">getServices</a></li><li><a href="global.html#handleNonXHR">handleNonXHR</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#ObjectID">ObjectID</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#prefixPath">prefixPath</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#SUCCESS">SUCCESS</a></li><li><a href="global.html#user_add">user_add</a></li><li><a href="global.html#user_add_role">user_add_role</a></li><li><a href="global.html#user_browse">user_browse</a></li><li><a href="global.html#user_edit">user_edit</a></li><li><a href="global.html#user_read">user_read</a></li><li><a href="global.html#user_read_permissions">user_read_permissions</a></li><li><a href="global.html#userRolesDeserializer">userRolesDeserializer</a></li><li><a href="global.html#WARNING">WARNING</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Mar 15 2019 18:58:56 GMT+0300 (Arab Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
